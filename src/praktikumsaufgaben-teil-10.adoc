include::header.inc.adoc[]

Ziel: Kennenlernen der Automatisierung von Softwareentwicklungsprozesse mit Hilfe von *Workflows* und *Actions* auf *GitHub*

== Praktikumsaufgaben Teil 10 - GitHub Actions

In diesem Aufgabenteil wollen wir erste M√∂glichkeiten von *Github Actions* kennenlernen, was *Workflows* sind und wie sie unsere Arbeit mit dem Repository auf GitHub unterst√ºtzen k√∂nnen.

include::hinweise-windows-labor.inc.adoc[]

{section-separator}

=== Einf√ºhrung in GitHub Actions

"GitHub Actions makes it easy to automate all your software workflows, now with world-class CI/CD. Build, test, and deploy your code right from GitHub. Make code reviews, branch management, and issue triaging work the way you want."
-- https://github.com/features/actions[Quelle: GitHub Actions]

==== GitHub Actions

Mit *GitHub Actions* k√∂nnen zus√§tzlich zu im Repository gehosteten und versionierten Quellcode Softwareentwicklungsprozesse in *Workflows* automatisiert werden. Diese sind auch unter dem Begriff *CI/CD* (_Continuous Integration, Continuous Delivery/Deployment_) bekannt. Damit k√∂nnen bspw. Tests, Buildvorg√§nge und das Bereitstellen der Software automatisiert werden.

Neben selbst erstellten Workflows, bieten GitHub und die Community eine Vielzahl von vorgefertigten Workflows und Actions an.

Informationen findet man in der offiziellen Dokumentation:

- https://docs.github.com/en/actions[GitHub Actions]
- https://docs.github.com/en/actions/learn-github-actions/introduction-to-github-actions[Introduction to GitHub Actions]

{bl}

==== Workflows

[#diagram_github-actions]
plantuml::{plantumlsdir}/diagram_github-actions.puml[format=svg, alt="Aufbau von Workflows in GitHub Actions", title="Aufbau von Workflows in GitHub Actions", target="{diagramsdir}/diagram_github-actions"]

Zu einem Repository k√∂nnen mit Hilfe von *GitHub Actions* verschiedene *Workflows* hinzugef√ºgt werden. *Workflows* werden durch festgelegte *Events* ausgel√∂st. *Workflows* bestehen aus einem oder mehreren *Jobs*, welche wiederum aus einem oder mehreren *Steps* bestehen. Die *Steps* enthalten jeweils eine *Action*. Jobs laufen standardm√§√üig parallel ab und Steps werden immer der Reihe nach ausgef√ºhrt.

GitHub Actions::
    GitHub Actions erm√∂glichen es zum Repository ein oder mehrere Workflows anzulegen und zu automatisieren.

Workflow::
    Ein Workflow ist eine zum Repository geh√∂render automatisierte Prozess, welcher in einer Datei mit YAML-Syntax unter `.github/workflows/` beschrieben wird. Workflows bestehen aus einem oder mehreren Jobs und k√∂nnen durch ein Ereignis ausgel√∂st werden. Man kann sie zum Erstellen (_build_), Testen (_test_), Packen (_package_), Freigeben (_release_) oder Bereitstellen (_deploy_) eines Projekts auf GitHub verwendet werden.

Event::
    Ein Event bzw. Ereignis ist eine bestimmte Aktivit√§t, welche einen Workflow ausl√∂st. Beispielsweise ein auf GitHub erfolgter Push oder Pull-Request.

Job::
    Ein Job besteht aus einer Reihe von Schritten (_Steps_), die auf demselben Runner ausgef√ºhrt werden. Mehrere Jobs in einem Workflow werden standardm√§√üig parallel ausgef√ºhrt. Es k√∂nnen zus√§tzlich Abh√§ngigkeiten definiert werden, sodass sie nacheinander bzw. in festgelegter Reihenfolge ausgef√ºhrt werden k√∂nnen.

Runner::
    Ein Runner ist eine virtuelle Umgebung bzw. spezieller Server in dem ein Job ausgef√ºhrt wird. Nach Beendigung des Jobs meldet der Runner den Fortschritt, die Protokolle und die Ergebnisse an GitHub zur√ºck. Von GitHub gehostete Runner basieren auf Ubuntu Linux, Microsoft Windows und macOS und jeder Job in einem Workflow wird in einer neuen virtuellen Umgebung ausgef√ºhrt.

Step::
Ein Step bzw. Schritt ist eine einzelne Aufgabe in einem Job, welche der Reihe nach ausgef√ºhrt werden. Ein Schritt kann entweder eine Aktion oder ein Shell-Befehl sein. Jeder Schritt in einem Job wird auf demselben Runner ausgef√ºhrt, sodass sie Daten miteinander teilen k√∂nnen.
+
IMPORTANT: Ob ein Step erfolgreich war, entscheidet der Exit-Code der Action. Tritt ein Fehler (`exit code != 0`) auf, werden standardm√§√üig keine nachfolgenden Steps mehr bearbeitet und der Job wird mit einem negativen Ergebnis beendet.

Action::
    Eine Action ist ein eigenst√§ndiger Befehle, der zu einem Step geh√∂rt. Actions sind die kleinsten Teile eines Workflows. Diese k√∂nnen Shell Kommandos (`run:`) oder von GitHub bzw. der Community vorbereitete Actions (`uses:`) sein.

Die Workflow-Dateien liegen im Repository unter dem Verzeichnis `.github/workflows/` im https://yaml.org/spec/1.2/spec.html[YAML]-Format. Jeder Workflow wird durch eine Datei mit der Endung _.yaml_ oder _.yml_, bspw. _example.yaml_, beschrieben.

.Hinweise: Workflows Syntax in einer YAML-Datei
[%collapsible]
====
=====
Ausf√ºhrliche Hinweise zur Syntax findet man unter: https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions[Workflow syntax for GitHub Actions].

.example.yaml
[source, yaml]
----
name: My Workflow <1>
on: [push, pull_request] <2>
jobs: <3>
  test: <4>
    name: My Tests <5>
    runs-on: ubuntu-latest <6>
    env: <7>
      MY_FILE: README.md

    steps: <8>
      # step 1 - action <9>
      - name: Checkout the repository <10>
        uses: actions/checkout@v2 <11>

      # step 2 - single line shell command
      - name: Check file
        run: test -f "$MY_FILE" <12>

      # step 3 - multi line shell command
      - name: Check versions
        run: | <13>
            echo "check versions:"
            git --version
            java -version
----
<1> ... `name: <workflow_name>` Name des Workflows
<2> ... `on:` Das Event (Ereignis), welches den Workflow ausl√∂st. Dies kann auch gezielt auf Branches oder Dateien/Verzeichnisse eingeschr√§nkt werden. Siehe <<example_event>>.
<3> ... `:jobs:` Bereich f√ºr alle Jobs in diesem Workflow
<4> ... `<job_id>:` Erster Job mit der eindeutigen ID "test" im Jobs Bereich
<5> ... `name: <job_name>` Legt den Namen eines Jobs fest.
<6> ... `runs-on:` Definiert den Runner mit seiner Umgebung `ubuntu-latest` f√ºr den zugeh√∂rigen Job. In diesem Falle die von GitHub gehostete virtuelle Umgebung mit Ubuntu Linux.
<7> ... `env:` Hier k√∂nnen Umgebungsvariablen, bspw. `JSON_FILE` definiert werden, welche in den Steps verwendet werden.
<8> ... `steps:` Bereich f√ºr alle Schritte zu einem Job.
<9> ... `#` Kommentar
<10> ... `- name: <step_name>` Legt den Namen eines Steps fest.
<11> ... `uses: <action>` Eine spezielle Action `actions/checkout@v2`, welche den Inhalt des Repositories in den Runner l√§d, so dass nachfolgende Actions damit arbeiten k√∂nnen.
<12> ... `run: <shell_command>` F√ºhrt statt einer vorgegebenen Action einen *einzeiliges* Shell-Kommando aus.
<13> ... `run: |` F√ºhrt ein *mehrzeiliges* Shell-Kommando aus.



.Beispiel eines komplexeren Events
[#example_event]
Folgend ein Beispiel f√ºr ein Event, welches auf *Push* und *Pull-Requests* f√ºr den Branch *main* und eine bestimmte Datei _data/colors.json_ reagiert:

[source, yaml]
----
on:
  push:
    branches: [ main ]
    paths:
      - 'data/colors.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/colors.json'
----

* https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#on[Workflow syntax for GitHub Actions: on]

=====
====

////
.Hinweise: YAML-Syntax #TODO#
[%collapsible]
====
=====
* https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions[Workflow syntax for GitHub Actions]
* https://en.wikipedia.org/wiki/YAML[Wikipedia: YAML]

.Listen und Arrays
[source, yaml]
----
# inline format
on: [push, pull_request]

# block format
on:
  - push:
  - pull_request:
# or (GitHub Actions Example)
on:
  push:
  pull_request:
----

.Schl√ºssel-Wert-Paare (key value)
[source, yaml]
----
--- # indented block
  name: John Smith
  age: 33
--- # inline block
{name: John Smith, age: 33}
----

.Einzeilige und Mehrzeilige Strings
[source, yaml]
----
# multi-line strings with newlines

----

=====
====
////


.Hinweise: Verwendung von Workflows auf GitHub
[%collapsible]
====
=====

Die Workflows der GitHub Actions findet man im Reiter *Actions*. Hier k√∂nnen sie verwaltet und die Ergebnisse eingesehen werden. √úber den Button kbd:[New workflows] k√∂nnen eigene Workflows angelegt oder aus Vorlagen passende ausgew√§hlt werden. Alternativ kann man die Workflow-Dateien auch direkt unter `.github/workflows` anlegen.

:imageTitle: GitHub Actions in GitHub
:imageFile: screenshot_github_github-actions.png
.{imageTitle}
image::{imageFile}["{imageTitle}", width=800, link="{imagesdir}/{imageFile}"]

Sind die Workflows angelegt, werden sie bei √Ñnderungen am Quellcode bzw. in Abh√§ngigkeit der festgelegten Events ausgef√ºhrt. Den Status der Workflows, ob sie erfolgreich ausgef√ºhrt werden konnten, erkennt man innerhalb der GitHub Oberfl√§che an Symbolen und Textangaben.

.Workflow-Statussymbole
[cols="^1,^1,7",width=75%]
|===
2+| Symbol | Bedeutung

| image:screenshot_github_github-actions_okay1.png["Haken (gr√ºn)", width=17]
| image:screenshot_github_github-actions_okay2.png["Haken (gr√ºn)", width=17]
| Workflow ist fehlerfrei durchgelaufen

| image:screenshot_github_github-actions_error1.png["Kreuz (rot)", width=17]
| image:screenshot_github_github-actions_error2.png["Kreuz (rot)", width=17]
| Workflow wurde mit Fehlern abgebrochen

| image:screenshot_github_github-actions_run1.png["Kreis (gelb)", width=17]
| image:screenshot_github_github-actions_run2.png["Kreis (gelb)", width=17]
| Workflow l√§uft gerade
|===

Folgend ein paar Screenshots der GitHub-Oberfl√§che:

:imageTitle: Pull-Request mit zus√§tzlichem Status der zugeh√∂rigen Workflows
:imageFile: screenshot_github_github-actions_workflow_status.png
.{imageTitle}
image::{imageFile}["{imageTitle}", width=800, link="{imagesdir}/{imageFile}"]

:imageTitle: Detailansicht eines erfolgreichen Jobs in einem Workflow
:imageFile: screenshot_github_github-actions_workflow_job_okay.png
.{imageTitle}
image::{imageFile}["{imageTitle}", width=800, link="{imagesdir}/{imageFile}"]

=====
====


{section-separator}

=== √úbungsaufgaben

==== Aufgabe 1 - Quickstart

Bearbeiten Sie die Aufgaben in Ihrem vorhandenem `htwd-se-example-project`-Repository oder legen Sie sich daf√ºr ein neues Repository auf GitHub an. Die Aufgabe orientiert sich am Einf√ºhrungsbeispiel: https://docs.github.com/en/actions/quickstart[Quickstart for GitHub Actions] von GitHub.

. Erstellen Sie in Ihrem _lokalen_-Repository das Verzeichnis `.github/workflows/`.
. Legen Sie in diesem die Workflow-Datei `github-actions-demo.yaml` an.
. √úbernehmen Sie in die Datei `github-actions-demo.yaml` die folgende Workflow-Beschreibung im YAML-Format:
+
.github-actions-demo.yaml
[%collapsible]
====
[source,yaml]
----
name: GitHub Actions Demo
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "üçè This job's status is ${{ job.status }}."

----
====
+
****
Die Vorgabe enth√§lt einen Workflow namens *GitHub Actions Demo*, welcher durch ein *Push*-Event ausgel√∂st wird und aus einem Job *Explore-GitHub-Actions* besteht. Der Job selbst besteht aus 8 Steps, welche Shell Kommandos und eine Action `actions/checkout@v2` zum Clonen Ihres Repository in den Runner (Ubuntu Linux) enthalten.
****
. √úbernehmen Sie die √Ñnderung als neue Version in Ihr Repository und pushen diese in das zugeh√∂rige _remote_-Repository auf GitHub.
. Sehen Sie sich auf GitHub im Reiter *Actions* das Ergebnis Ihres Workflows an. Dies kann einen Moment dauern.

{section-separator}

==== Aufgabe 2 - Unit-Tests

In dieser Aufgabe wollen wir ein kleines Projekt automatisiert mit Unit-Tests in einem Workflow testen lassen. Es gibt eine Varianten in *Java* (Maven) und eine in *Python* (Unittest).

Daf√ºr verwenden wir das bereitgestellte https://github.com/tigion/htw-se-practical-github-actions-exercise[htw-se-practical-github-actions-exercise] Repository. Sie k√∂nnen dies gern mit Ihren Klassen aus dem Praktikum zum Thema *UnitTest mit Java und Python* erweitern bzw. anpassen.

. Erstellen Sie sich vom Repository https://github.com/tigion/htw-se-practical-github-actions-exercise[htw-se-practical-github-actions-exercise] einen Fork in Ihren GitHub Account und clonen ihn anschlie√üend lokal auf Ihren Rechner.
. Legen Sie sich im Verzeichnis `.github/workflows/` entweder eine neue Workflow-Datei `maven-test.yaml` oder `python-test.yaml` an.
. √úbernehmen Sie entsprechend folgenden Inhalt:
+
.maven-test.yaml
[%collapsible]
====
[source,yaml]
----
# This workflow will test a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Unit tests with Maven

on:
  push:
    branches: [ main ]
    paths:
      - 'example-java/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'example-java/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    # step 1 - clone project
    - name: Checkout the repository
      uses: actions/checkout@v2

    # step 2 - provide java
    - name: Set up JDK 16
      uses: actions/setup-java@v2
      with:
        java-version: '16'
        distribution: 'adopt'

    # step 3 - run tests
    - name: Test with Maven
      run: |
        cd example-java
        mvn -B test --file pom.xml
----
====
+
.python-test.yaml
[%collapsible]
====
[source,yaml]
----
# This workflow will test a Python project

name: Unit tests with Python

on:
  push:
    branches: [ main ]
    paths:
      - 'example-python/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'example-python/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    # step 1 - clone project
    - name: Checkout the repository
      uses: actions/checkout@v2

    # step 2 - provide python
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # step 3 - run tests
    - name: Test with Python
      run: |
        cd example-python
        python3 -m unittest tests.test_town.TestTown
----
====
+
****
Die Workflows werden jeweils durch *Push*- und *Pull-Request*-Events im *master*-Branch auf ihr jeweiliges Verzeichnis `example-java` bzw. `example-python` ausgel√∂st. Im Job *test* werden im Runner unter Ubuntu Linux drei Steps der Reihe nach ausgef√ºhrt:

. Projekt clonen
. Umgebung bereitstellen
. Unit-Tests ausf√ºhren
****
. √úbernehmen Sie die eben angelegten Workflow-Dateien als neue Version in Ihr Repository und pushen diese zum _remote_-Repository.
. Nehmen Sie eine √Ñnderung (bspw. Kommentar in der jeweiligen Main-Klasse/-Methode) im Verzeichnis `example-java` oder `example-python` vor und als neue Version in das Repository auf, um den zugeh√∂rigen Workflow auszul√∂sen.
. Sehen Sie sich auf GitHub im Reiter *Actions* das Ergebnis Ihres Workflows an. Dies kann einen Moment dauern.
. Ein Test ist fehlgeschlagen. Es darf nicht m√∂glich sein, Einwohnerzahlen kleiner 0 einzugeben. Passen sie die *Town*-Klassen so an, dass bei weiteren Pushs keine Tests mehr fehlschlagen. Je nach Testanforderung, ist eine Exception oder ein minimaler Standardwert von 0 zu verwenden.
+
.icon:warning[role=red] *Spoiler Alert* icon:warning[role=red] <- enth√§lt L√∂sungsvorschl√§ge
[%collapsible]
====
.Java:
[source,java]
----
public void setResidents(int residents) {
  // variant: exception
  if (residents < 0)
    throw new IllegalArgumentException("residents must be equal or greater than 0: " + residents);
  this.residents = residents;

  // variant: min default value 0
  //this.residents = (residents < 0) ? 0 : residents;
}
----

.Python:
[source,python]
----
@residents.setter
    def residents(self, value):
        # variant: min default value 0
        self.__residents = 0 if value < 0 else value

        # variant: exception
        #if value < 0:
        #    raise ValueError("residents must be equal or greater than 0")
        #self.__residents = value
----
====
. √úberlegen Sie sich eine Erweiterung des Workflows, welche Sie als weiteren Step hinzuf√ºgen. Dies k√∂nnte bspw. die Ausgabe der Java- oder Python-Version oder ein Test, ob eine Datei existiert sein. Testen Sie anschlie√üend durch √Ñnderungen am Projekt, ob Ihre Anpassungen im Workflow funktionieren.


{section-separator}

==== Aufgabe 3 - Diskussion

. Schauen Sie sich im Demo-Projekt https://github.com/tigion/htw-playground-fork-colors[htw-playground-fork-colors] aus dem Praktikum <<praktikumsaufgaben-teil-08.adoc#_aufgabe_1_2_fork_mit_pull_request, Teil 6 - Aufgabe 1.2 Fork mit Pull-Request>> den enthaltenen Workflow an. Dieser enth√§lt Beispiele f√ºr komplexere Shell Kommandos und Testm√∂glichkeiten.
. Diskutieren Sie in Ihrem Projektteam, ob es in Ihrem Beleg-Projekt sinnvolle M√∂glichkeiten f√ºr den Einsatz von GitHub Actions gibt und ob diese umsetzbar w√§ren.


include::sitemap.inc.adoc[]
